
// const data = "1,Main menu,,,,,,,,,,,\r\n,,4,Motor,,,,,,,,,\r\n,,,,4.1,Status,,,,,,,\r\n,,,,,,4.1.1,Motor Current,,,,,\r\n,,,,,,4.1.2,Motor Voltage,,,,,\r\n,,,,,,4.1.3,Motor Electrical Power,,,,,\r\n,,,,,,4.1.4,Motor Shaft Power,,,,,\r\n,,,,,,4.1.5,Motor Thermal Load,,,,,\r\n,,,,4.2,Motor Data,,,,,,,\r\n,,,,,,4.2.1,General Settings,,,,,\r\n,,,,,,,,4.2.1.1,Motor Type,,,\r\n,,,,,,,,4.2.1.2,Number of Pole Pairs,,,\r\n,,,,,,,,4.2.1.3,AMA Mode,,,\r\n,,,,,,,,4.2.1.4,AMA Timeout,,,\r\n,,,,,,,,4.2.1.5,Motor Cable Length,,,\r\n,,,,,,4.2.2,Nameplate Data,,,,,\r\n,,,,,,,,4.2.2.1,Nominal Power,,,\r\n,,,,,,,,4.2.2.2,Nominal Current,,,\r\n,,,,,,,,4.2.2.3,Nominal Speed,,,\r\n,,,,,,,,4.2.2.4,Nominal Frequency,,,\r\n,,,,,,,,4.2.2.5,Nominal Voltage,,,\r\n,,,,,,4.2.3,Asyn. Induction Motor,,,,,\r\n,,,,,,,,4.2.3.1,Stator Resistance Rs,,,\r\n,,,,,,,,4.2.3.2,Rotor Resistance Rr,,,\r\n,,,,,,,,4.2.3.3,Stator Leakage Inductance Lls,,,\r\n,,,,,,,,4.2.3.4,Rotor Leakage Inductance Llr,,,\r\n,,,,,,,,4.2.3.5,Magnetizing Inductance Lm,,,\r\n,,,,,,,,4.2.3.6,Iron Loss Resistance Rfe,,,\r\n,,,,,,4.2.4,Permanent Magnet Motor,,,,,\r\n,,,,,,,,4.2.4.1,Back EMF,,,\r\n,,,,,,,,4.2.4.2,Stator Resistance Rs,,,\r\n,,,,,,,,4.2.4.3,d-axis Inductance Ld,,,\r\n,,,,,,,,4.2.4.4,d-axis Inductance LdSat,,,\r\n,,,,,,,,4.2.4.5,Ld Shift,,,\r\n,,,,,,,,4.2.4.6,Ld Current Point,,,\r\n,,,,,,,,4.2.4.7,q-axis Inductance Lq,,,\r\n,,,,,,,,4.2.4.8,q-axis Inductance LqSat,,,\r\n,,,,,,,,4.2.4.9,Lq Shift,,,\r\n,,,,,,,,4.2.4.10,Lq Current Point,,,\r\n,,,,4.3,Motor Temperature,,,,,,,\r\n,,,,,,4.3.1,High Motor Temperature Response,,,,,\r\n,,,,,,4.3.2,Motor IEC Duty Cycle,,,,,\r\n,,,,,,4.3.3,Zero Speed Cooling Capacity,,,,,\r\n,,,,,,4.3.4,Motor Temperature Class,,,,,\r\n,,,,,,4.3.5,Motor Ambient Temperature,,,,,\r\n,,,,,,4.3.6,Motor Thermal Time Constant,,,,,\r\n,,,,4.4,Motor Control,,,,,,,\r\n,,,,,,4.4.1,General Settings,,,,,\r\n,,,,,,,,4.4.1.1,AEO Minimum Frequency,,,\r\n,,,,,,,,4.4.1.2,AEO Minimum Magnetization,,,\r\n,,,,,,,,4.4.1.3,Breakaway Current Boost,,,\r\n,,,,,,4.4.2,AC-Brake,,,,,\r\n,,,,,,,,4.4.2.1,Enable AC-Brake,,,\r\n,,,,,,,,4.4.2.2,AC-Brake Voltage Control Kp,,,\r\n,,,,,,,,4.4.2.3,AC-Brake Voltage Control Ti,,,\r\n,,,,,,4.4.3,U/f Settings,,,,,\r\n,,,,,,,,4.4.3.1,Voltage Point 0,,,\r\n,,,,,,,,4.4.3.2,Voltage Point 1,,,\r\n,,,,,,,,4.4.3.3,Voltage Point 2,,,\r\n,,,,,,,,4.4.3.7,Frequency Point 0,,,\r\n,,,,,,,,4.4.3.8,Frequency Point 1,,,\r\n,,,,,,,,4.4.3.9,Frequency Point 2,,,\r\n,,5,Application,,,,,,,,,\r\n,,,,5.1,Status,,,,,,,\r\n,,,,,,5.1.1,Load Drooping Frequency,,,,,\r\n,,,,,,5.1.2,Motor Ctrl. Status Word,,,,,\r\n,,,,,,5.1.3,Motor Ctrl. Ready Status Word,,,,,\r\n,,,,,,5.1.4,Motor Regulator Status Word,,,,,\r\n,,,,,,5.1.5,Application Specific Status Word 1,,,,,\r\n,,,,,,5.1.6,Application Specific Status Word 2,,,,,\r\n,,,,,,5.1.7,Fault Word 1,,,,,\r\n,,,,,,5.1.8,Fault Word 2,,,,,\r\n,,,,,,5.1.9,Warning Word 1,,,,,\r\n,,,,,,5.1.10,Warning Word 2,,,,,\r\n,,,,,,5.1.11,Grid Ctrl. Status Word,,,,,\r\n,,,,5.2,Protection,,,,,,,\r\n,,,,,,5.2.1,Cooling Monitor,,,,,\r\n,,,,,,,,5.2.1.1,Cooling Monitor Input,,,\r\n,,,,,,,,5.2.1.2,Cooling Monitor Delay,,,\r\n,,,,,,,,5.2.1.3,Cooling Monitor Response,,,\r\n,,,,,,5.2.2,External Exception,,,,,\r\n,,,,,,,,5.2.2.1,Ext. Exception 1 NO Input,,,\r\n,,,,,,,,5.2.2.2,Ext. Exception 1 NC Input,,,\r\n,,,,,,,,5.2.2.3,Ext. Exception 1 Response,,,\r\n,,,,,,,,5.2.2.3,Ext. Exception 1 Response,,,\r\n,,,,,,,,5.2.2.4,Ext. Exception 2 NO Input,,,\r\n,,,,,,,,5.2.2.5,Ext. Exception 2 NC Input,,,\r\n,,,,,,,,5.2.2.6,Ext. Exception 2 Response,,,\r\n,,,,,,,,5.2.2.6,Ext. Exception 2 Response,,,\r\n,,,,,,,,5.2.2.7,Ext. Exception Active Output,,,\r\n,,,,,,5.2.3,Measured Temp. Protection,,,,,\r\n,,,,,,,,5.2.3.1,Status,,,\r\n,,,,,,,,,,5.2.3.1.1,Protection Temp. Probe Input 1 ,\r\n,,,,,,,,,,5.2.3.1.2,Protection Temp. Probe Input 2,\r\n,,,,,,,,,,5.2.3.1.3,Protection Temp. Probe Input 3,\r\n,,,,,,,,,,5.2.3.1.4,Protection Temp. Probe Input 4,\r\n,,,,,,,,,,5.2.3.1.5,Protection Temp. Probe Input 5,\r\n,,,,,,,,,,5.2.3.1.6,Protection Temp. Probe Input 6,\r\n,,,,,,,,5.2.3.2,Protection 1,,,\r\n,,,,,,,,,,5.2.3.2.1,Probe Input 1,\r\n,,,,,,,,,,5.2.3.2.2,Stage 1 Temp. Limit 1,\r\n,,,,,,,,,,5.2.3.2.3,Stage 2 Temp. Limit 1,\r\n,,,,,,,,,,5.2.3.2.4,Stage 2 Temp. Response 1,\r\n,,,,,,,,5.2.3.3,Protection 2,,,\r\n,,,,,,,,,,5.2.3.3.1,Probe Input 2,\r\n,,,,,,,,,,5.2.3.3.2,Stage 1 Temp. Limit 2,\r\n,,,,,,,,,,5.2.3.3.3,Stage 2 Temp. Limit 2,\r\n,,,,,,,,,,5.2.3.3.4,Stage 2 Temp. Response 2,\r\n,,,,,,,,5.2.3.4,Protection 3,,,\r\n,,,,,,,,,,5.2.3.4.1,Probe Input 3,\r\n,,,,,,,,,,5.2.3.4.2,Stage 1 Temp. Limit 3,\r\n2,Quick menu 1,,,,,,,,,,,\r\n,,4.2.2.1,Nominal Power,,,,,,,,,\r\n,,4.2.2.2,Nominal Current,,,,,,,,,\r\n,,4.2.2.3,Nominal Speed,,,,,,,,,\r\n,,4.2.2.4,Nominal Frequency,,,,,,,,,\r\n,,4.2.2.5,Nominal Voltage,,,,,,,,,\r\n3,Quick menu 2,,,,,,,,,,,\r\n,,4.4.1.1,AEO Minimum Frequency,,,,,,,,,\r\n,,5.2.3.1.1,Protection Temp. Probe Input 1 ,,,,,,,,,\r\n,,5.2.3.2.2,Stage 1 Temp. Limit 1,,,,,,,,,\r\n,,5.2.3.4.1,Probe Input 3,,,,,,,,,\r\n";

function parseData2Array(str) {
    // 1. 按行分割 2. 按逗号分割 3. 返回二维数组
    return str.split('\r\n').map((line) => {
        return line;
    });
}

/**
 * 构建平级的array
 * @param data
 * @returns {*[]}
 */
function buildArray(data) {
    const tree = [];  // 存储树的数组
    const parent_tack = [];  // 用于跟踪当前位置的堆栈父节点
    let i = 0;
    // 读取行
    for (let line = 0; line < data.length; line++) {
        const parts =data[line].split(',');
        const lineStr = parts.filter(Boolean).map(item => item.trim());
        const lineID = lineStr[0];
        const node = {
            id: '', // 设置为ID
            parent_id: '', // 设置为parent_id
            name: '', // 内容是name字段
            children: [], // 初始化children数组
            isQuickMenu: false,
            inQuickMenu: false,
        };
        // 读取列
        for (i = 0; i < parts.length; i++) {
            const id = parts[i];
            const name = parts[i + 1];

            if (id !== '' && name !== '') {
                node.id = parts[i];
                node.name = parts[i + 1];
                // 判断是否有父节点
                const p = data[line - 1];
                const c = data[line];
                const n = data[line + 1];
                // 查询父节点
                if (lineID === '1') {
                    node.parent_id = "";
                    parent_tack.push(lineID);
                    tree.push(node);
                    break;
                }
                // 查询有没有下一个节点
                if (!!n) {
                    const nArray = n.split(',');
                    if (nArray[i + 2] !== '' && nArray[i + 3] !== '') {
                        node.parent_id = parent_tack[parent_tack.length - 1] || 0;
                        parent_tack.push(lineID);
                        tree.push(node);
                        break;
                    }
                    if ( nArray[i] !== ''){  // 有没有兄弟节点
                        node.parent_id = parent_tack[parent_tack.length - 1] || 0;
                        node.value = Math.floor(Math.random() * 101); // 生成0-100之间的随机值
                        tree.push(node);
                        break;
                    }
                    // 是否为最后一个节点
                    if (nArray[i] ==='' && (nArray[i - 1] !=='' || nArray[i - 2] !=='')) {
                        node.parent_id = parent_tack[parent_tack.length - 1] || 0;
                        node.value = Math.floor(Math.random() * 101); // 生成0-100之间的随机值
                        tree.push(node);
                        parent_tack.pop();
                        break;
                    }
                    // 是否为最后一个节点并且是大级别跳跃
                    if (nArray[i] ==='' && (nArray[i - 1] ==='' && nArray[i - 2] ==='')){
                        node.parent_id = parent_tack[parent_tack.length - 1] || 0;
                        tree.push(node);
                        // 找到不为空的元素的索引
                        const notNullIndexes = nArray.reduce((indexes, element, index) => {
                            if (element !== '') {
                                indexes.push(index);
                            }
                            return indexes;
                        }, []);
                        let popCount = (i - notNullIndexes[0])/2 || 0;
                        while (popCount > 0){
                            parent_tack.pop();
                            popCount--;
                        }
                        break;
                    }
                }
            }
        }
    }
    return tree;
}

/**
 * 把平级arr 根据parentId 来构建树
 * @param data
 * @param parentId
 * @returns {*[]}
 */
function buildTree(data, parentId) {
    const tree = [];
    data.forEach(item => {
        if (item.parent_id === parentId || (parentId === "" && !item.parent_id)) {
            const newNode = {
                id: item.id, // 设置为ID
                parent_id: item.parent_id, // 设置为parent_id
                name: item.name, // 内容是name字段
                children:  buildTree(data, item.id), // 递归构建子节点
                isQuickMenu: item.isQuickMenu,
                inQuickMenu: item.inQuickMenu,
            };
            if (item.id === '2' || item.id === '3') {
                delete newNode.isQuickMenu;
                delete newNode.inQuickMenu;
            }
            tree.push(newNode);
            // console.log(newNode);
        }
    });

    return tree;
}

function parseCSVString(data){
    const array = parseData2Array(data);
    const array1 = buildArray(array);
    const parseCSV2ArrayTree = buildTree(array1, "");
    console.log(parseCSV2ArrayTree);
    return parseCSV2ArrayTree;
}
export default parseCSVString;